<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Zoomable Image</title>
    <style>
        #svg-container {
            width: 100%;
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #zoomable-image {
            width: 100%;
            height: auto;
        }

        .svg-border {
            border: 2px solid black;
        }
    </style>
    <!-- Include D3.js library -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>

<body>

    <div class="container">


        <div class="container-fluid" id="svg-container">
            <svg id="diagram" width="800" height="800" class="svg-border">
                <g class="zoomable">
                    <g transform="matrix(1,0,0,1,0,0)">
                        <g id="">
                            <defs>
                                <marker id="arrow-10-[#333]" viewBox="0 0 10 10" refX="0" refY="5" markerWidth="10"
                                    markerHeight="10" markerUnits="userSpaceOnUse" orient="auto" fill="#333">
                                    <path d="M 0 0 L 10 5 L 0 10 z"></path>
                                </marker>
                            </defs>
                            <g class="nodes">
                                <g id="Brown" transform="translate(-50 0)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(99, 28, 28); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Brown</text>
                                </g>
                                <g id="Nose" transform="translate(-160 160)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(250, 158, 0); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Nose</text>
                                </g>
                                <g id="EyeBrowA" transform="translate(50 -320)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">EyeBrowA</text>
                                </g>
                                <g id="EyeBrowB" transform="translate(160 -160)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">EyeBrowB</text>
                                </g>
                                <g id="Eye2" transform="translate(150 0)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(245, 0, 0); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Eye2</text>
                                </g>
                                <g id="Eye1" transform="translate(-50 -160)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(245, 0, 0); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Eye1</text>
                                </g>
                                <g id="Mouth" transform="translate(-160 320)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(107, 179, 0); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Mouth</text>
                                </g>
                                <g id="Blue" transform="translate(160 160)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(0, 8, 255); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Blue</text>
                                </g>
                            </g>
                            <g class="edges">
                                <g id="FacePart<:below:EyeBrowA->Eye1">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M12.500000000000028,-290L2.083333333333357,-281.6666666666667C-8.333333333333314,-273.3333333333333,-29.166666666666657,-256.6666666666667,-39.58290163675944,-241.66666666666666C-49.99913660685221,-226.66666666666666,-49.99827321370443,-213.33333333333334,-49.99784151713053,-206.66666666666666L-49.99740982055664,-200">
                                    </path>
                                    <path
                                        d="M12.500000000000028,-290L2.083333333333357,-281.6666666666667C-8.333333333333314,-273.3333333333333,-29.166666666666657,-256.6666666666667,-39.583333333333336,-240C-50,-223.33333333333334,-50.00000000000001,-206.66666666666666,-50.00000000000001,-198.33333333333334L-50.000000000000014,-190"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="-33.5548210144043" y="-248.35423278808594" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="FacePart<:below:Eye2->Nose">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M100,27.586206896551737L84.16666666666667,36.32183908045978C68.33333333333333,45.05747126436783,36.666666666666664,62.52873563218392,3.166356404622396,79.8301738870555C-30.333953857421875,97.13161214192708,-65.66790771484375,114.26322428385417,-83.33488464355469,122.8290303548177L-101.00186157226562,131.39483642578125">
                                    </path>
                                    <path
                                        d="M100,27.586206896551737L84.16666666666667,36.32183908045978C68.33333333333333,45.05747126436783,36.666666666666664,62.52873563218392,1.6666666666666667,80.55729710902125C-33.333333333333336,98.58585858585859,-71.66666666666667,117.17171717171715,-90.83333333333333,126.46464646464644L-110,135.75757575757572"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="-4.058701992034912" y="83.49586486816406" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="FacePart<:below:Nose->Mouth">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-160,190L-160,198.33333333333334C-160,206.66666666666666,-160,223.33333333333334,-160,238.33333333333334C-160,253.33333333333334,-160,266.6666666666667,-160,273.3333333333333L-160,280">
                                    </path>
                                    <path
                                        d="M-160,190L-160,198.33333333333334C-160,206.66666666666666,-160,223.33333333333334,-160,240C-160,256.6666666666667,-160,273.3333333333333,-160,281.6666666666667L-160,290"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text x="-160" y="240"
                                        dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="FacePart<:below:EyeBrowB->Eye2">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M160,-130L160,-121.66666666666667C160,-113.33333333333333,160,-96.66666666666667,159.1650187174479,-81.65380096435547C158.33003743489584,-66.64093526204427,156.66007486979166,-53.28187052408854,155.8250935872396,-46.60233815511068L154.9901123046875,-39.92280578613281">
                                    </path>
                                    <path
                                        d="M160,-130L160,-121.66666666666667C160,-113.33333333333333,160,-96.66666666666667,158.95833333333334,-80C157.91666666666666,-63.333333333333336,155.83333333333334,-46.666666666666664,154.79166666666666,-38.333333333333336L153.75,-30"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="158.95010375976562" y="-79.8704833984375" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="FacePart<:below:Eye1->Nose">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-91.24999999999997,-130L-102.70833333333331,-121.66666666666667C-114.16666666666664,-113.33333333333333,-137.08333333333334,-96.66666666666667,-148.54166666666666,-75C-160,-53.333333333333336,-160,-26.666666666666668,-160,0C-160,26.666666666666668,-160,53.333333333333336,-160,73.3333346048991C-160,93.33333587646484,-160,106.66667175292969,-160,113.33333969116211L-160,120.00000762939453">
                                    </path>
                                    <path
                                        d="M-91.24999999999997,-130L-102.70833333333331,-121.66666666666667C-114.16666666666664,-113.33333333333333,-137.08333333333334,-96.66666666666667,-148.54166666666666,-75C-160,-53.333333333333336,-160,-26.666666666666668,-160,0C-160,26.666666666666668,-160,53.333333333333336,-160,75C-160,96.66666666666667,-160,113.33333333333333,-160,121.66666666666667L-160,130"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="-159.94558715820312" y="-13.399565696716309" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="Eye<:color:Eye2->Blue">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M153.75,30L154.79166666666666,38.333333333333336C155.83333333333334,46.666666666666664,157.91666666666666,63.333333333333336,158.95828755696616,78.33333206176758C159.99990844726562,93.33333079020183,159.99981689453125,106.66666158040364,159.99977111816406,113.33332697550456L159.99972534179688,119.99999237060547">
                                    </path>
                                    <path
                                        d="M153.75,30L154.79166666666666,38.333333333333336C155.83333333333334,46.666666666666664,157.91666666666666,63.333333333333336,158.95833333333334,80C160,96.66666666666667,160,113.33333333333333,160,121.66666666666667L160,130"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="158.95010375976562" y="79.8704833984375" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">color</text>
                                </g>
                                <g id="Eye<:color:Eye1->Brown">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-50,-130L-50,-121.66666666666667C-50,-113.33333333333333,-50,-96.66666666666667,-50,-81.66666730244954C-50,-66.66666793823242,-50,-53.333335876464844,-50,-46.666669845581055L-50,-40.000003814697266">
                                    </path>
                                    <path
                                        d="M-50,-130L-50,-121.66666666666667C-50,-113.33333333333333,-50,-96.66666666666667,-50,-80C-50,-63.333333333333336,-50.00000000000001,-46.666666666666664,-50.00000000000001,-38.333333333333336L-50.000000000000014,-30"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text x="-50" y="-80"
                                        dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">color</text>
                                </g>
                                <g id="FacePart<:aligned:EyeBrowA->EyeBrowB">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M91.24999999999997,-290L102.70833333333331,-281.6666666666667C114.16666666666664,-273.3333333333333,137.08333333333334,-256.6666666666667,148.54119364420572,-241.66666666666666C159.99905395507812,-226.66666666666666,159.99810791015625,-213.33333333333334,159.9976348876953,-206.66666666666666L159.99716186523438,-200">
                                    </path>
                                    <path
                                        d="M91.24999999999997,-290L102.70833333333331,-281.6666666666667C114.16666666666664,-273.3333333333333,137.08333333333334,-256.6666666666667,148.54166666666666,-240C160,-223.33333333333334,160,-206.66666666666666,160,-198.33333333333334L160,-190"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="140.98912048339844" y="-249.37435913085938" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">aligned</text>
                                </g>
                                <g id="FacePart<:aligned:Eye1->Eye2">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-8.750000000000014,-130L2.7083333333333215,-121.66666666666667C14.166666666666657,-113.33333333333333,37.08333333333333,-96.66666666666667,56.67098490397135,-81.10727310180664C76.25863647460938,-65.54787953694661,92.51727294921875,-51.09575907389323,100.64659118652344,-43.86969884236654L108.77590942382812,-36.643638610839844">
                                    </path>
                                    <path
                                        d="M-8.750000000000014,-130L2.7083333333333215,-121.66666666666667C14.166666666666657,-113.33333333333333,37.08333333333333,-96.66666666666667,57.916666666666664,-80C78.75,-63.333333333333336,97.5,-46.666666666666664,106.875,-38.333333333333336L116.24999999999999,-30"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="55.37408447265625" y="-82.02574157714844" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">aligned</text>
                                </g>
                            </g>
                        </g>
                    </g>

                </g>
            </svg>
        </div>
    </div>
    <script>
        // Add zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 10]) // Set the zoom scale extent
            .on('zoom', zoomed);

        function zoomed(event) {
            d3.select('.zoomable').attr('transform', event.transform);
        }
        const diagram = d3.select('#diagram');
        diagram.call(zoom);


        // Select all nodes and make them draggable
        const nodes = d3.selectAll('.nodes g');

        function getNodePositions() {
            const positions = {};
            nodes.each(function () {
                const node = d3.select(this);
                const transform = node.attr('transform');
                const translate = transform.match(/translate\(([^, ]+)[, ]+([^)]+)\)/);
                if (translate) {
                    const x = parseFloat(translate[1]);
                    const y = parseFloat(translate[2]);
                    positions[node.attr('id')] = { x, y };
                }
            });
            console.log(positions);
            return positions;
        }

        // Store the initial positions of the nodes
        const nodePositions = getNodePositions();

        function getEdgeSourceAndTarget(edgeId) {
            // First find the id of the last : character and get the substring after it
            const byParts = edgeId.split(':');
            let rel = byParts[byParts.length - 1];

            const [sourceId, targetId] = rel.split('->');
            return { sourceId, targetId };
        }

        function updatePath(path, startX, startY, endX, endY) {
            const controlPoint1 = `${(startX + endX) / 2},${startY}`;
            const controlPoint2 = `${(startX + endX) / 2},${endY}`;
            const newD = `M${startX},${startY} C${controlPoint1},${controlPoint2},${endX},${endY}`;
            path.attr('d', newD);
        }

        function getIntersectionPoint(node, targetNode) {
            const dx = targetNode.x - node.x;
            const dy = targetNode.y - node.y;
            const absDx = Math.abs(dx);
            const absDy = Math.abs(dy);

            let x = node.x;
            let y = node.y;

            const halfWidth = 50;
            const halfHeight = 30;

            if (absDx > absDy) {
                x += dx > 0 ? halfWidth : -halfWidth;
                y += dy * (halfWidth / absDx);
            } else {
                x += dx * (halfHeight / absDy);
                y += dy > 0 ? halfHeight : -halfHeight;
            }

            return { x, y };
        }

        function updateEdges(nodeId) {
            const node = nodePositions[nodeId];
            // Update edges where the node is the source
            d3.selectAll(`g[id*=":${nodeId}->"]`).each(function () {
                const edge = d3.select(this);
                const edgeId = edge.attr('id');

                const { sourceId, targetId } = getEdgeSourceAndTarget(edgeId);
                //assert (sourceId === nodeId);

                const targetNode = nodePositions[targetId];
                const sourceIntersection = getIntersectionPoint(node, targetNode);
                const targetIntersection = getIntersectionPoint(targetNode, node);
                edge.select('path').each(function () {
                    updatePath(d3.select(this), sourceIntersection.x, sourceIntersection.y, targetIntersection.x, targetIntersection.y);
                });

                // Update the position of the label
                edge.select('text').attr('x', (sourceIntersection.x + targetIntersection.x) / 2)
                    .attr('y', (sourceIntersection.y + targetIntersection.y) / 2);
            });

            // Update edges where the node is the target
            d3.selectAll(`g[id*="->${nodeId}"]`).each(function () {
                const edge = d3.select(this);
                const edgeId = edge.attr('id');

                const { sourceId, targetId } = getEdgeSourceAndTarget(edgeId);
                //assert (targetId === nodeId);

                const sourceNode = nodePositions[sourceId];
                const sourceIntersection = getIntersectionPoint(sourceNode, node);
                const targetIntersection = getIntersectionPoint(node, sourceNode);
                edge.select('path').each(function () {
                    updatePath(d3.select(this), sourceIntersection.x, sourceIntersection.y, targetIntersection.x, targetIntersection.y);
                });

                // Update the position of the label
                edge.select('text').attr('x', (sourceIntersection.x + targetIntersection.x) / 2)
                    .attr('y', (sourceIntersection.y + targetIntersection.y) / 2);
            });
        }

        nodes
            .call(d3.drag()
                .on('start', dragStarted)
                .on('drag', dragged)
                .on('end', dragEnded));

        function dragStarted(event, d) {
            d3.select(this).raise().attr('stroke', 'black');
        }

        function dragged(event, d) {
            const nodeId = d3.select(this).attr('id');
            nodePositions[nodeId].x = event.x;
            nodePositions[nodeId].y = event.y;
            d3.select(this).attr('transform', `translate(${event.x}, ${event.y})`);
            updateEdges(nodeId); // Update the edges during the drag event
        }

        function dragEnded(event, d) {
            d3.select(this).attr('stroke', null);
        }



        /**** This bit ensures we zoom to fit ***/
        const bbox = d3.select('.zoomable').node().getBBox();
        const padding = 10; // Padding in pixels

        const viewBox = [
            bbox.x - padding,
            bbox.y - padding,
            bbox.width + 2 * padding,
            bbox.height + 2 * padding
        ].join(' ');


        const topSvg = d3.select("#diagram");
        topSvg.attr('viewBox', viewBox);
        /*************************************/

    </script>
</body>

</html>