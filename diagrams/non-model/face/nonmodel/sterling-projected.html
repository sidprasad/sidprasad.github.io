<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Zoomable Image</title>
    <style>
        #svg-container {
            width: 100%;
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #zoomable-image {
            width: 100%;
            height: auto;
        }

        .svg-border {
            border: 2px solid black;
        }
    </style>
    <!-- Include D3.js library -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>

<body>

    <div class="container">


        <div class="container-fluid" id="svg-container">
            <svg id="diagram" width="800" height="800" class="svg-border">
                <g class="zoomable">
                    <g
                        transform="matrix(0.6176292612961254,0,0,0.6176292612961254,67.19049830855161,-7.053486371313699)">
                        <g id="">
                            <defs>
                                <marker id="arrow-10-[#333]" viewBox="0 0 10 10" refX="0" refY="5" markerWidth="10"
                                    markerHeight="10" markerUnits="userSpaceOnUse" orient="auto" fill="#333">
                                    <path d="M 0 0 L 10 5 L 0 10 z"></path>
                                </marker>
                            </defs>
                            <g class="nodes">
                                <g id="Mouth" transform="translate(-72.5 400)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(0, 80, 240); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Mouth</text>
                                </g>
                                <g id="Nose" transform="translate(-72.5 240)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(36, 168, 0); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Nose</text>
                                </g>
                                <g id="Chin" transform="translate(-72.5 560)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(158, 108, 0); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Chin</text>
                                </g>
                                <g id="EyeBrowA" transform="translate(-82.5 -400)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(87, 12, 228); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">EyeBrowA</text>
                                </g>
                                <g id="EyeBrowB" transform="translate(82.5 80)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(87, 12, 228); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">EyeBrowB</text>
                                </g>
                                <g id="Eye2" transform="translate(-27.5 -80)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(228, 7, 7); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Eye2</text>
                                </g>
                                <g id="Eye1" transform="translate(-82.5 -240)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(228, 7, 7); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Eye1</text>
                                </g>
                                <g id="Hair" transform="translate(-27.5 -560)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(179, 140, 0); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Hair</text>
                                </g>
                            </g>
                            <g class="edges">
                                <g id="FacePart<:below:EyeBrowA->Eye1">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-82.5,-370L-82.5,-361.6666666666667C-82.5,-353.3333333333333,-82.5,-336.6666666666667,-82.5,-321.6666666666667C-82.5,-306.6666666666667,-82.5,-293.3333333333333,-82.5,-286.6666666666667L-82.5,-280">
                                    </path>
                                    <path
                                        d="M-82.5,-370L-82.5,-361.6666666666667C-82.5,-353.3333333333333,-82.5,-336.6666666666667,-82.5,-320C-82.5,-303.3333333333333,-82.5,-286.6666666666667,-82.5,-278.3333333333333L-82.5,-270"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text x="-82.5"
                                        y="-320" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="FacePart<:below:Eye2->Nose">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-44.375,-50L-49.0625,-41.666666666666664C-53.75,-33.333333333333336,-63.125,-16.666666666666668,-67.8125,5C-72.5,26.666666666666668,-72.5,53.333333333333336,-72.5,80C-72.5,106.66666666666667,-72.5,133.33333333333334,-72.5,153.3333307902018C-72.5,173.3333282470703,-72.5,186.66665649414062,-72.5,193.33332061767578L-72.5,199.99998474121094">
                                    </path>
                                    <path
                                        d="M-44.375,-50L-49.0625,-41.666666666666664C-53.75,-33.333333333333336,-63.125,-16.666666666666668,-67.8125,5C-72.5,26.666666666666668,-72.5,53.333333333333336,-72.5,80C-72.5,106.66666666666667,-72.5,133.33333333333334,-72.5,155C-72.5,176.66666666666666,-72.5,193.33333333333334,-72.5,201.66666666666666L-72.5,210"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="-72.49978637695312" y="77.32907104492188" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="FacePart<:below:Nose->Mouth">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-72.5,270L-72.5,278.3333333333333C-72.5,286.6666666666667,-72.5,303.3333333333333,-72.5,318.3333333333333C-72.5,333.3333333333333,-72.5,346.6666666666667,-72.5,353.3333333333333L-72.5,360">
                                    </path>
                                    <path
                                        d="M-72.5,270L-72.5,278.3333333333333C-72.5,286.6666666666667,-72.5,303.3333333333333,-72.5,320C-72.5,336.6666666666667,-72.5,353.3333333333333,-72.5,361.6666666666667L-72.5,370"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text x="-72.5"
                                        y="320" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="FacePart<:below:Mouth->Chin">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-72.5,430L-72.5,438.3333333333333C-72.5,446.6666666666667,-72.5,463.3333333333333,-72.5,478.3333333333333C-72.5,493.3333333333333,-72.5,506.6666666666667,-72.5,513.3333333333334L-72.5,520">
                                    </path>
                                    <path
                                        d="M-72.5,430L-72.5,438.3333333333333C-72.5,446.6666666666667,-72.5,463.3333333333333,-72.5,480C-72.5,496.6666666666667,-72.5,513.3333333333334,-72.5,521.6666666666666L-72.5,530"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text x="-72.5"
                                        y="480" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="FacePart<:below:Hair->EyeBrowA">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-48.125,-530L-53.854166666666664,-521.6666666666666C-59.583333333333336,-513.3333333333334,-71.04166666666667,-496.6666666666667,-76.77059555053711,-481.6666666666667C-82.49952443440755,-466.6666666666667,-82.49904886881511,-453.3333333333333,-82.49881108601888,-446.6666666666667L-82.49857330322266,-440">
                                    </path>
                                    <path
                                        d="M-48.125,-530L-53.854166666666664,-521.6666666666666C-59.583333333333336,-513.3333333333334,-71.04166666666667,-496.6666666666667,-76.77083333333333,-480C-82.5,-463.3333333333333,-82.5,-446.6666666666667,-82.5,-438.3333333333333L-82.5,-430"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="-75.53013610839844" y="-483.3867492675781" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="FacePart<:below:Hair->EyeBrowB">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M17.500000000000014,-530L30.00000000000001,-521.6666666666666C42.50000000000001,-513.3333333333334,67.5,-496.6666666666667,80,-475C92.5,-453.3333333333333,92.5,-426.6666666666667,92.5,-400C92.5,-373.3333333333333,92.5,-346.6666666666667,92.5,-320C92.5,-293.3333333333333,92.5,-266.6666666666667,92.5,-240C92.5,-213.33333333333334,92.5,-186.66666666666666,92.5,-160C92.5,-133.33333333333334,92.5,-106.66666666666667,92.5,-80C92.5,-53.333333333333336,92.5,-26.666666666666668,91.66499328613281,-6.653802871704102C90.82998657226562,13.359060923258463,89.15997314453125,26.718121846516926,88.32496643066406,33.39765230814616L87.48995971679688,40.07718276977539">
                                    </path>
                                    <path
                                        d="M17.500000000000014,-530L30.00000000000001,-521.6666666666666C42.50000000000001,-513.3333333333334,67.5,-496.6666666666667,80,-475C92.5,-453.3333333333333,92.5,-426.6666666666667,92.5,-400C92.5,-373.3333333333333,92.5,-346.6666666666667,92.5,-320C92.5,-293.3333333333333,92.5,-266.6666666666667,92.5,-240C92.5,-213.33333333333334,92.5,-186.66666666666666,92.5,-160C92.5,-133.33333333333334,92.5,-106.66666666666667,92.5,-80C92.5,-53.333333333333336,92.5,-26.666666666666668,91.45833333333333,-5C90.41666666666667,16.666666666666668,88.33333333333333,33.333333333333336,87.29166666666667,41.666666666666664L86.25,50"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text x="92.5"
                                        y="-255.345458984375" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="FacePart<:below:EyeBrowB->Nose">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M82.5,110L82.5,118.33333333333333C82.5,126.66666666666667,82.5,143.33333333333334,66.48103459676106,159.93451944986978C50.46206919352213,176.53570556640625,18.42413838704427,193.0714111328125,2.4051729838053384,201.33926391601562L-13.613792419433594,209.60711669921875">
                                    </path>
                                    <path
                                        d="M82.5,110L82.5,118.33333333333333C82.5,126.66666666666667,82.5,143.33333333333334,65,160.69892473118279C47.5,178.06451612903223,12.5,196.12903225806448,-5,205.1612903225806L-22.5,214.19354838709674"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="46.58564376831055" y="175.48968505859375" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="FacePart<:below:Eye1->Nose">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-103.125,-210L-108.85416666666667,-201.66666666666666C-114.58333333333333,-193.33333333333334,-126.04166666666667,-176.66666666666666,-131.77083333333334,-155C-137.5,-133.33333333333334,-137.5,-106.66666666666667,-137.5,-80C-137.5,-53.333333333333336,-137.5,-26.666666666666668,-137.5,0C-137.5,26.666666666666668,-137.5,53.333333333333336,-137.5,80C-137.5,106.66666666666667,-137.5,133.33333333333334,-131.78015518188477,153.70647684733072C-126.06031036376953,174.07962036132812,-114.62062072753906,188.15924072265625,-108.90077590942383,195.1990509033203L-103.1809310913086,202.23886108398438">
                                    </path>
                                    <path
                                        d="M-103.125,-210L-108.85416666666667,-201.66666666666666C-114.58333333333333,-193.33333333333334,-126.04166666666667,-176.66666666666666,-131.77083333333334,-155C-137.5,-133.33333333333334,-137.5,-106.66666666666667,-137.5,-80C-137.5,-53.333333333333336,-137.5,-26.666666666666668,-137.5,0C-137.5,26.666666666666668,-137.5,53.333333333333336,-137.5,80C-137.5,106.66666666666667,-137.5,133.33333333333334,-130.72916666666666,155C-123.95833333333333,176.66666666666666,-110.41666666666667,193.33333333333334,-103.64583333333333,201.66666666666666L-96.87500000000001,210"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text x="-137.5"
                                        y="1.413421630859375" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="FacePart<:aligned:Eye2->EyeBrowB">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-6.875,-50L-1.1458333333333333,-41.666666666666664C4.583333333333333,-33.333333333333336,16.041666666666668,-16.666666666666668,26.555784861246746,-1.3734029134114583C37.06990305582682,13.91986083984375,46.63980611165365,27.8397216796875,51.424757639567055,34.799652099609375L56.20970916748047,41.75958251953125">
                                    </path>
                                    <path
                                        d="M-6.875,-50L-1.1458333333333333,-41.666666666666664C4.583333333333333,-33.333333333333336,16.041666666666668,-16.666666666666668,27.5,0C38.958333333333336,16.666666666666668,50.416666666666664,33.333333333333336,56.145833333333336,41.666666666666664L61.87500000000001,50"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="27.500001907348633" y="0.000003814697265625" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">aligned</text>
                                </g>
                                <g id="FacePart<:aligned:Eye1->Eye2">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-61.875,-210L-56.145833333333336,-201.66666666666666C-50.416666666666664,-193.33333333333334,-38.958333333333336,-176.66666666666666,-33.22940540313721,-161.66666793823242C-27.500477472941082,-146.6666692097982,-27.50095494588216,-133.33333841959634,-27.501193682352703,-126.66667302449544L-27.501432418823242,-120.00000762939453">
                                    </path>
                                    <path
                                        d="M-61.875,-210L-56.145833333333336,-201.66666666666666C-50.416666666666664,-193.33333333333334,-38.958333333333336,-176.66666666666666,-33.229166666666664,-160C-27.500000000000004,-143.33333333333334,-27.50000000000001,-126.66666666666667,-27.50000000000001,-118.33333333333333L-27.500000000000014,-110"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="-34.469871520996094" y="-163.38674926757812" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">aligned</text>
                                </g>
                            </g>
                        </g>
                    </g>


                </g>
            </svg>
        </div>
    </div>
    <script>
        // Add zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 10]) // Set the zoom scale extent
            .on('zoom', zoomed);

        function zoomed(event) {
            d3.select('.zoomable').attr('transform', event.transform);
        }
        const diagram = d3.select('#diagram');
        diagram.call(zoom);


        // Select all nodes and make them draggable
        const nodes = d3.selectAll('.nodes g');

        function getNodePositions() {
            const positions = {};
            nodes.each(function () {
                const node = d3.select(this);
                const transform = node.attr('transform');
                const translate = transform.match(/translate\(([^, ]+)[, ]+([^)]+)\)/);
                if (translate) {
                    const x = parseFloat(translate[1]);
                    const y = parseFloat(translate[2]);
                    positions[node.attr('id')] = { x, y };
                }
            });
            console.log(positions);
            return positions;
        }

        // Store the initial positions of the nodes
        const nodePositions = getNodePositions();

        function getEdgeSourceAndTarget(edgeId) {
            // First find the id of the last : character and get the substring after it
            const byParts = edgeId.split(':');
            let rel = byParts[byParts.length - 1];

            const [sourceId, targetId] = rel.split('->');
            return { sourceId, targetId };
        }

        function updatePath(path, startX, startY, endX, endY) {
            const controlPoint1 = `${(startX + endX) / 2},${startY}`;
            const controlPoint2 = `${(startX + endX) / 2},${endY}`;
            const newD = `M${startX},${startY} C${controlPoint1},${controlPoint2},${endX},${endY}`;
            path.attr('d', newD);
        }

        function getIntersectionPoint(node, targetNode) {
            const dx = targetNode.x - node.x;
            const dy = targetNode.y - node.y;
            const absDx = Math.abs(dx);
            const absDy = Math.abs(dy);

            let x = node.x;
            let y = node.y;

            const halfWidth = 50;
            const halfHeight = 30;

            if (absDx > absDy) {
                x += dx > 0 ? halfWidth : -halfWidth;
                y += dy * (halfWidth / absDx);
            } else {
                x += dx * (halfHeight / absDy);
                y += dy > 0 ? halfHeight : -halfHeight;
            }

            return { x, y };
        }

        function updateEdges(nodeId) {
            const node = nodePositions[nodeId];
            // Update edges where the node is the source
            d3.selectAll(`g[id*=":${nodeId}->"]`).each(function () {
                const edge = d3.select(this);
                const edgeId = edge.attr('id');

                const { sourceId, targetId } = getEdgeSourceAndTarget(edgeId);
                //assert (sourceId === nodeId);

                const targetNode = nodePositions[targetId];
                const sourceIntersection = getIntersectionPoint(node, targetNode);
                const targetIntersection = getIntersectionPoint(targetNode, node);
                edge.select('path').each(function () {
                    updatePath(d3.select(this), sourceIntersection.x, sourceIntersection.y, targetIntersection.x, targetIntersection.y);
                });

                // Update the position of the label
                edge.select('text').attr('x', (sourceIntersection.x + targetIntersection.x) / 2)
                    .attr('y', (sourceIntersection.y + targetIntersection.y) / 2);
            });

            // Update edges where the node is the target
            d3.selectAll(`g[id*="->${nodeId}"]`).each(function () {
                const edge = d3.select(this);
                const edgeId = edge.attr('id');

                const { sourceId, targetId } = getEdgeSourceAndTarget(edgeId);
                //assert (targetId === nodeId);

                const sourceNode = nodePositions[sourceId];
                const sourceIntersection = getIntersectionPoint(sourceNode, node);
                const targetIntersection = getIntersectionPoint(node, sourceNode);
                edge.select('path').each(function () {
                    updatePath(d3.select(this), sourceIntersection.x, sourceIntersection.y, targetIntersection.x, targetIntersection.y);
                });

                // Update the position of the label
                edge.select('text').attr('x', (sourceIntersection.x + targetIntersection.x) / 2)
                    .attr('y', (sourceIntersection.y + targetIntersection.y) / 2);
            });
        }

        nodes
            .call(d3.drag()
                .on('start', dragStarted)
                .on('drag', dragged)
                .on('end', dragEnded));

        function dragStarted(event, d) {
            d3.select(this).raise().attr('stroke', 'black');
        }

        function dragged(event, d) {
            const nodeId = d3.select(this).attr('id');
            nodePositions[nodeId].x = event.x;
            nodePositions[nodeId].y = event.y;
            d3.select(this).attr('transform', `translate(${event.x}, ${event.y})`);
            updateEdges(nodeId); // Update the edges during the drag event
        }

        function dragEnded(event, d) {
            d3.select(this).attr('stroke', null);
        }



        /**** This bit ensures we zoom to fit ***/
        const bbox = d3.select('.zoomable').node().getBBox();
        const padding = 10; // Padding in pixels

        const viewBox = [
            bbox.x - padding,
            bbox.y - padding,
            bbox.width + 2 * padding,
            bbox.height + 2 * padding
        ].join(' ');


        const topSvg = d3.select("#diagram");
        topSvg.attr('viewBox', viewBox);
        /*************************************/

    </script>
</body>

</html>