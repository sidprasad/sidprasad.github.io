<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Zoomable Image</title>
    <style>
        #svg-container {
            width: 100%;
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #zoomable-image {
            width: 100%;
            height: auto;
        }

        .svg-border {
            border: 2px solid black;
        }
    </style>
    <!-- Include D3.js library -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>

<body>

    <div class="container">


        <div class="container-fluid" id="svg-container">
            <svg id="diagram" width="800" height="800" class="svg-border">
                <g class="zoomable">
                    <g
                        transform="matrix(0.7252458330245966,0,0,0.7252458330245966,116.71047505957684,-1.0329327324394173)">
                        <g id="">
                            <defs>
                                <marker id="arrow-10-[#333]" viewBox="0 0 10 10" refX="0" refY="5" markerWidth="10"
                                    markerHeight="10" markerUnits="userSpaceOnUse" orient="auto" fill="#333">
                                    <path d="M 0 0 L 10 5 L 0 10 z"></path>
                                </marker>
                            </defs>
                            <g class="nodes">
                                <g id="Brown" transform="translate(-155 80)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(99, 28, 28); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Brown</text>
                                </g>
                                <g id="Nose" transform="translate(55 240)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(250, 158, 0); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Nose</text>
                                </g>
                                <g id="EyeBrowA" transform="translate(155 -400)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">EyeBrowA</text>
                                </g>
                                <g id="EyeBrowB" transform="translate(65 80)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">EyeBrowB</text>
                                </g>
                                <g id="Eye2" transform="translate(-90 -80)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(245, 0, 0); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Eye2</text>
                                </g>
                                <g id="Eye1" transform="translate(155 -240)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(245, 0, 0); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Eye1</text>
                                </g>
                                <g id="Mouth" transform="translate(55 400)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(107, 179, 0); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Mouth</text>
                                </g>
                                <g id="Blue" transform="translate(110 -80)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(0, 8, 255); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Blue</text>
                                </g>
                            </g>
                            <g class="edges">
                                <g id="FacePart<:below:EyeBrowA->Eye1">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M155,-370L155,-361.6666666666667C155,-353.3333333333333,155,-336.6666666666667,155,-321.6666666666667C155,-306.6666666666667,155,-293.3333333333333,155,-286.6666666666667L155,-280">
                                    </path>
                                    <path
                                        d="M155,-370L155,-361.6666666666667C155,-353.3333333333333,155,-336.6666666666667,155,-320C155,-303.3333333333333,155,-286.6666666666667,155,-278.3333333333333L155,-270"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text x="155" y="-320"
                                        dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="FacePart<:below:Eye2->Nose">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-73.125,-50L-68.4375,-41.666666666666664C-63.75,-33.333333333333336,-54.375,-16.666666666666668,-49.6875,5C-45,26.666666666666668,-45,53.333333333333336,-45,80C-45,106.66666666666667,-45,133.33333333333334,-35.88478167851766,153.9588419596354C-26.76956335703532,174.5843505859375,-8.539126714070639,189.168701171875,0.5760916074117025,196.46087646484375L9.691309928894043,203.7530517578125">
                                    </path>
                                    <path
                                        d="M-73.125,-50L-68.4375,-41.666666666666664C-63.75,-33.333333333333336,-54.375,-16.666666666666668,-49.6875,5C-45,26.666666666666668,-45,53.333333333333336,-45,80C-45,106.66666666666667,-45,133.33333333333334,-34.583333333333336,155C-24.16666666666667,176.66666666666666,-3.3333333333333406,193.33333333333334,7.083333333333324,201.66666666666666L17.49999999999999,210"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="-44.986412048339844" y="88.73329162597656" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="FacePart<:below:Nose->Mouth">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M55,270L55,278.3333333333333C55,286.6666666666667,55,303.3333333333333,55,318.3333333333333C55,333.3333333333333,55,346.6666666666667,55,353.3333333333333L55,360">
                                    </path>
                                    <path
                                        d="M55,270L55,278.3333333333333C55,286.6666666666667,55,303.3333333333333,55,320C55,336.6666666666667,54.99999999999999,353.3333333333333,54.99999999999999,361.6666666666667L54.999999999999986,370"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text x="55" y="320"
                                        dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="FacePart<:below:EyeBrowB->Nose">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M65,110L65,118.33333333333333C65,126.66666666666667,65,143.33333333333334,64.16490681966145,158.34618377685547C63.329813639322914,173.3590342203776,61.659627278645836,186.71806844075522,60.82453409830729,193.397585550944L59.98944091796875,200.0771026611328">
                                    </path>
                                    <path
                                        d="M65,110L65,118.33333333333333C65,126.66666666666667,65,143.33333333333334,63.958333333333336,160C62.916666666666664,176.66666666666666,60.833333333333336,193.33333333333334,59.791666666666664,201.66666666666666L58.75000000000001,210"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="63.950111389160156" y="160.1295166015625" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="FacePart<:below:Eye1->Nose">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M179.375,-210L186.14583333333334,-201.66666666666666C192.91666666666666,-193.33333333333334,206.45833333333334,-176.66666666666666,213.22916666666666,-155C220,-133.33333333333334,220,-106.66666666666667,220,-80C220,-53.333333333333336,220,-26.666666666666668,220,0C220,26.666666666666668,220,53.333333333333336,220,80C220,106.66666666666667,220,133.33333333333334,202.33302307128906,155.23247273763022C184.66604614257812,177.1316121419271,149.33209228515625,194.26322428385416,131.6651153564453,202.82903035481772L113.99813842773438,211.39483642578125">
                                    </path>
                                    <path
                                        d="M179.375,-210L186.14583333333334,-201.66666666666666C192.91666666666666,-193.33333333333334,206.45833333333334,-176.66666666666666,213.22916666666666,-155C220,-133.33333333333334,220,-106.66666666666667,220,-80C220,-53.333333333333336,220,-26.666666666666668,220,0C220,26.666666666666668,220,53.333333333333336,220,80C220,106.66666666666667,220,133.33333333333334,200.83333333333334,155.95959595959596C181.66666666666666,178.58585858585857,143.33333333333334,197.17171717171718,124.16666666666667,206.46464646464642L105,215.75757575757572"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text x="220"
                                        y="26.65936279296875" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">below</text>
                                </g>
                                <g id="Eye<:color:Eye2->Brown">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-114.375,-50L-121.14583333333333,-41.666666666666664C-127.91666666666667,-33.333333333333336,-141.45833333333334,-16.666666666666668,-148.22888692220053,-1.6666679382324219C-154.99944051106772,13.333330790201822,-154.9988810221354,26.666661580403645,-154.99860127766928,33.333326975504555L-154.99832153320312,39.99999237060547">
                                    </path>
                                    <path
                                        d="M-114.375,-50L-121.14583333333333,-41.666666666666664C-127.91666666666667,-33.333333333333336,-141.45833333333334,-16.666666666666668,-148.22916666666666,0C-155,16.666666666666668,-155,33.333333333333336,-155,41.666666666666664L-155,50"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="-146.2554473876953" y="-4.474800109863281" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">color</text>
                                </g>
                                <g id="Eye<:color:Eye1->Blue">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M138.125,-210L133.4375,-201.66666666666666C128.75,-193.33333333333334,119.375,-176.66666666666666,114.68769454956055,-161.66666666666666C110.0003890991211,-146.66666666666666,110.00077819824219,-133.33333333333334,110.00097274780273,-126.66666666666667L110.00116729736328,-120">
                                    </path>
                                    <path
                                        d="M138.125,-210L133.4375,-201.66666666666666C128.75,-193.33333333333334,119.375,-176.66666666666666,114.6875,-160C110,-143.33333333333334,110,-126.66666666666667,110,-118.33333333333333L110,-110"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="115.38773345947266" y="-162.37890625" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">color</text>
                                </g>
                                <g id="FacePart<:aligned:Eye2->EyeBrowB">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-40,-54.19354838709679L-22.5,-45.16129032258066C-5,-36.12903225806453,30,-18.064516129032263,47.49927647908529,-2.365591397849465C64.99855295817058,13.333333333333334,64.99710591634114,26.666666666666668,64.99638239542644,33.333333333333336L64.99565887451172,40">
                                    </path>
                                    <path
                                        d="M-40,-54.19354838709679L-22.5,-45.16129032258066C-5,-36.12903225806453,30,-18.064516129032263,47.5,-0.6989247311827983C65,16.666666666666668,65,33.333333333333336,65,41.666666666666664L65,50"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="29.08578109741211" y="-15.489898681640625" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">aligned</text>
                                </g>
                                <g id="FacePart<:aligned:Eye1->Eye2">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M105,-223.6734693877551L72.5,-213.0612244897959C40,-202.44897959183672,-25,-181.22448979591834,-57.4986572265625,-163.94557441659524C-89.997314453125,-146.66665903727213,-89.99462890625,-133.33331807454428,-89.9932861328125,-126.66664759318034L-89.991943359375,-119.9999771118164">
                                    </path>
                                    <path
                                        d="M105,-223.6734693877551L72.5,-213.0612244897959C40,-202.44897959183672,-25,-181.22448979591834,-57.5,-162.27891156462584C-90,-143.33333333333334,-90,-126.66666666666667,-90,-118.33333333333333L-90,-110"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="-8.451729774475098" y="-184.7396697998047" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">aligned</text>
                                </g>
                            </g>
                        </g>
                    </g>
                </g>
            </svg>
        </div>
    </div>
    <script>
        // Add zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 10]) // Set the zoom scale extent
            .on('zoom', zoomed);

        function zoomed(event) {
            d3.select('.zoomable').attr('transform', event.transform);
        }
        const diagram = d3.select('#diagram');
        diagram.call(zoom);


        // Select all nodes and make them draggable
        const nodes = d3.selectAll('.nodes g');

        function getNodePositions() {
            const positions = {};
            nodes.each(function () {
                const node = d3.select(this);
                const transform = node.attr('transform');
                const translate = transform.match(/translate\(([^, ]+)[, ]+([^)]+)\)/);
                if (translate) {
                    const x = parseFloat(translate[1]);
                    const y = parseFloat(translate[2]);
                    positions[node.attr('id')] = { x, y };
                }
            });
            console.log(positions);
            return positions;
        }

        // Store the initial positions of the nodes
        const nodePositions = getNodePositions();

        function getEdgeSourceAndTarget(edgeId) {
            // First find the id of the last : character and get the substring after it
            const byParts = edgeId.split(':');
            let rel = byParts[byParts.length - 1];

            const [sourceId, targetId] = rel.split('->');
            return { sourceId, targetId };
        }

        function updatePath(path, startX, startY, endX, endY) {
            const controlPoint1 = `${(startX + endX) / 2},${startY}`;
            const controlPoint2 = `${(startX + endX) / 2},${endY}`;
            const newD = `M${startX},${startY} C${controlPoint1},${controlPoint2},${endX},${endY}`;
            path.attr('d', newD);
        }

        function getIntersectionPoint(node, targetNode) {
            const dx = targetNode.x - node.x;
            const dy = targetNode.y - node.y;
            const absDx = Math.abs(dx);
            const absDy = Math.abs(dy);

            let x = node.x;
            let y = node.y;

            const halfWidth = 50;
            const halfHeight = 30;

            if (absDx > absDy) {
                x += dx > 0 ? halfWidth : -halfWidth;
                y += dy * (halfWidth / absDx);
            } else {
                x += dx * (halfHeight / absDy);
                y += dy > 0 ? halfHeight : -halfHeight;
            }

            return { x, y };
        }

        function updateEdges(nodeId) {
            const node = nodePositions[nodeId];
            // Update edges where the node is the source
            d3.selectAll(`g[id*=":${nodeId}->"]`).each(function () {
                const edge = d3.select(this);
                const edgeId = edge.attr('id');

                const { sourceId, targetId } = getEdgeSourceAndTarget(edgeId);
                //assert (sourceId === nodeId);

                const targetNode = nodePositions[targetId];
                const sourceIntersection = getIntersectionPoint(node, targetNode);
                const targetIntersection = getIntersectionPoint(targetNode, node);
                edge.select('path').each(function () {
                    updatePath(d3.select(this), sourceIntersection.x, sourceIntersection.y, targetIntersection.x, targetIntersection.y);
                });

                // Update the position of the label
                edge.select('text').attr('x', (sourceIntersection.x + targetIntersection.x) / 2)
                    .attr('y', (sourceIntersection.y + targetIntersection.y) / 2);
            });

            // Update edges where the node is the target
            d3.selectAll(`g[id*="->${nodeId}"]`).each(function () {
                const edge = d3.select(this);
                const edgeId = edge.attr('id');

                const { sourceId, targetId } = getEdgeSourceAndTarget(edgeId);
                //assert (targetId === nodeId);

                const sourceNode = nodePositions[sourceId];
                const sourceIntersection = getIntersectionPoint(sourceNode, node);
                const targetIntersection = getIntersectionPoint(node, sourceNode);
                edge.select('path').each(function () {
                    updatePath(d3.select(this), sourceIntersection.x, sourceIntersection.y, targetIntersection.x, targetIntersection.y);
                });

                // Update the position of the label
                edge.select('text').attr('x', (sourceIntersection.x + targetIntersection.x) / 2)
                    .attr('y', (sourceIntersection.y + targetIntersection.y) / 2);
            });
        }

        nodes
            .call(d3.drag()
                .on('start', dragStarted)
                .on('drag', dragged)
                .on('end', dragEnded));

        function dragStarted(event, d) {
            d3.select(this).raise().attr('stroke', 'black');
        }

        function dragged(event, d) {
            const nodeId = d3.select(this).attr('id');
            nodePositions[nodeId].x = event.x;
            nodePositions[nodeId].y = event.y;
            d3.select(this).attr('transform', `translate(${event.x}, ${event.y})`);
            updateEdges(nodeId); // Update the edges during the drag event
        }

        function dragEnded(event, d) {
            d3.select(this).attr('stroke', null);
        }



        /**** This bit ensures we zoom to fit ***/
        const bbox = d3.select('.zoomable').node().getBBox();
        const padding = 10; // Padding in pixels

        const viewBox = [
            bbox.x - padding,
            bbox.y - padding,
            bbox.width + 2 * padding,
            bbox.height + 2 * padding
        ].join(' ');


        const topSvg = d3.select("#diagram");
        topSvg.attr('viewBox', viewBox);
        /*************************************/

    </script>
</body>

</html>