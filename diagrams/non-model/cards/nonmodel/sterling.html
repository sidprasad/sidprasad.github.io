<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Zoomable Image</title>
    <style>
        #svg-container {
            width: 100%;
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #zoomable-image {
            width: 100%;
            height: auto;
        }

        .svg-border {
            border: 2px solid black;
        }
    </style>
    <!-- Include D3.js library -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>

<body>

    <div class="container">


        <div class="container-fluid" id="svg-container">
            <svg id="diagram" width="800" height="800" class="svg-border">
                <g class="zoomable">


                    <g
                        transform="matrix(0.6515988706674123,0,0,0.6515988706674123,-99.90865814290817,39.53406022927265)">
                        <g id="">
                            <defs>
                                <marker id="arrow-10-[#333]" viewBox="0 0 10 10" refX="0" refY="5" markerWidth="10"
                                    markerHeight="10" markerUnits="userSpaceOnUse" orient="auto" fill="#333">
                                    <path d="M 0 0 L 10 5 L 0 10 z"></path>
                                </marker>
                            </defs>
                            <g class="nodes">
                                <g id="Card0" transform="translate(-90 240)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(237, 2, 2); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Card0</text>
                                </g>
                                <g id="Card1" transform="translate(275 400)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(237, 2, 2); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Card1</text>
                                </g>
                                <g id="Card2" transform="translate(-385 80)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(237, 2, 2); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Card2</text>
                                </g>
                                <g id="Card3" transform="translate(-100 -80)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(237, 2, 2); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Card3</text>
                                </g>
                                <g id="Card4" transform="translate(385 -240)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(237, 2, 2); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Card4</text>
                                </g>
                                <g id="Player0" transform="translate(365 -400)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(1, 63, 249); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="-0.16999999999999998em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Player0</text><text
                                        x="0" y="0" dy="0.8300000000000001em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">hand:
                                        Card4</text>
                                </g>
                                <g id="Player1" transform="translate(-65 -240)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(1, 63, 249); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="-0.16999999999999998em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Player1</text><text
                                        x="0" y="0" dy="0.8300000000000001em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">hand:
                                        Card3</text>
                                </g>
                                <g id="Player2" transform="translate(-375 -80)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(1, 63, 249); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="-0.16999999999999998em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Player2</text><text
                                        x="0" y="0" dy="0.8300000000000001em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">hand:
                                        Card2</text>
                                </g>
                                <g id="Player3" transform="translate(275 240)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(1, 63, 249); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="-0.16999999999999998em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Player3</text><text
                                        x="0" y="0" dy="0.8300000000000001em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">hand:
                                        Card1</text>
                                </g>
                                <g id="Player4" transform="translate(-130 80)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(1, 63, 249); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="-0.16999999999999998em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Player4</text><text
                                        x="0" y="0" dy="0.8300000000000001em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">hand:
                                        Card0</text>
                                </g>
                                <g id="Dealer0" transform="translate(374.7088861843115 -658.5768161535498)">
                                    <rect x="-50" y="-30" width="100" height="60"
                                        style="stroke: rgb(188, 143, 255); stroke-width: 1; fill: rgb(255, 255, 255);">
                                    </rect><text x="0" y="0" dy="0.33em"
                                        style="font-family: monospace; font-size: 14px; text-anchor: middle; user-select: none; fill: rgb(51, 51, 51);">Dealer0</text>
                                </g>
                            </g>
                            <g class="edges">
                                <g id="Player<:left:Player0->Player1">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M315,-390.6976744186046L251.66666666666666,-378.9147286821705C188.33333333333334,-367.1317829457364,61.666666666666664,-343.56589147286815,-1.6640523274739583,-325.11625872471535C-64.99477132161458,-306.6666259765625,-64.98954264322917,-293.333251953125,-64.98692830403645,-286.66656494140625L-64.98431396484375,-279.9998779296875">
                                    </path>
                                    <path
                                        d="M315,-390.6976744186046L251.66666666666666,-378.9147286821705C188.33333333333334,-367.1317829457364,61.666666666666664,-343.56589147286815,-1.6666666666666667,-323.44961240310073C-65,-303.3333333333333,-65,-286.6666666666667,-65,-278.3333333333333L-65,-270"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="111.37272644042969" y="-351.4429626464844" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">left</text>
                                </g>
                                <g id="Player<:left:Player1->Player2">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-115,-227.09677419354838L-158.33333333333334,-215.91397849462365C-201.66666666666666,-204.73118279569894,-288.3333333333333,-182.36559139784947,-331.6648763020833,-164.51611885973202C-374.9964192708333,-146.6666463216146,-374.9928385416667,-133.33329264322916,-374.9910481770833,-126.66661580403645L-374.9892578125,-119.99993896484375">
                                    </path>
                                    <path
                                        d="M-115,-227.09677419354838L-158.33333333333334,-215.91397849462365C-201.66666666666666,-204.73118279569894,-288.3333333333333,-182.36559139784947,-331.6666666666667,-162.8494623655914C-375,-143.33333333333334,-375,-126.66666666666667,-375,-118.33333333333333L-375,-110"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="-260.0655517578125" y="-188.05563354492188" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">left</text>
                                </g>
                                <g id="Player<:left:Player2->Player4">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-329.0625,-50L-184.31021118164062,44.53211212158203"></path>
                                    <path d="M-329.0625,-50L-175.93750000000003,50" stroke="transparent"
                                        stroke-width="11" fill="none"></path><text x="-252.5" y="-0.000003814697265625"
                                        dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">left</text>
                                </g>
                                <g id="Player<:left:Player3->Player0">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M325,221.81818181818184L353.3333333333333,211.51515151515153C381.6666666666667,201.21212121212125,438.3333333333333,180.60606060606062,466.6666666666667,156.96969696969697C495,133.33333333333334,495,106.66666666666667,495,80C495,53.333333333333336,495,26.666666666666668,495,0C495,-26.666666666666668,495,-53.333333333333336,495,-80C495,-106.66666666666667,495,-133.33333333333334,495,-160C495,-186.66666666666666,495,-213.33333333333334,495,-240C495,-266.6666666666667,495,-293.3333333333333,482.8777618408203,-314.1265055338542C470.7555236816406,-334.919677734375,446.51104736328125,-349.83935546875,434.38880920410156,-357.2991943359375L422.2665710449219,-364.759033203125">
                                    </path>
                                    <path
                                        d="M325,221.81818181818184L353.3333333333333,211.51515151515153C381.6666666666667,201.21212121212125,438.3333333333333,180.60606060606062,466.6666666666667,156.96969696969697C495,133.33333333333334,495,106.66666666666667,495,80C495,53.333333333333336,495,26.666666666666668,495,0C495,-26.666666666666668,495,-53.333333333333336,495,-80C495,-106.66666666666667,495,-133.33333333333334,495,-160C495,-186.66666666666666,495,-213.33333333333334,495,-240C495,-266.6666666666667,495,-293.3333333333333,481.4583333333333,-315C467.9166666666667,-336.6666666666667,440.8333333333333,-353.3333333333333,427.2916666666667,-361.6666666666667L413.75,-370"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text x="495"
                                        y="-41.682220458984375" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">left</text>
                                </g>
                                <g id="Player<:left:Player4->Player3">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-160,110L-168.33333333333334,118.33333333333333C-176.66666666666666,126.66666666666667,-193.33333333333334,143.33333333333334,-130.8111114501953,163.35418192545572C-68.2888895670573,183.37503051757812,73.42222086588542,206.75006103515625,144.27777608235678,218.4375762939453L215.13333129882812,230.12509155273438">
                                    </path>
                                    <path
                                        d="M-160,110L-168.33333333333334,118.33333333333333C-176.66666666666666,126.66666666666667,-193.33333333333334,143.33333333333334,-129.16666666666666,163.6254295532646C-65,183.91752577319588,80,207.83505154639178,152.5,219.7938144329897L225,231.75257731958763"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="3.71836519241333" y="193.9257354736328" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">left</text>
                                </g>
                                <g id="Player<:right:Player0->Player3">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M331.25,-370L321.875,-361.6666666666667C312.5,-353.3333333333333,293.75,-336.6666666666667,284.375,-315C275,-293.3333333333333,275,-266.6666666666667,275,-240C275,-213.33333333333334,275,-186.66666666666666,275,-160C275,-133.33333333333334,275,-106.66666666666667,275,-80C275,-53.333333333333336,275,-26.666666666666668,275,0C275,26.666666666666668,275,53.333333333333336,275,80C275,106.66666666666667,275,133.33333333333334,275,153.3333307902018C275,173.3333282470703,275,186.66665649414062,275,193.33332061767578L275,199.99998474121094">
                                    </path>
                                    <path
                                        d="M331.25,-370L321.875,-361.6666666666667C312.5,-353.3333333333333,293.75,-336.6666666666667,284.375,-315C275,-293.3333333333333,275,-266.6666666666667,275,-240C275,-213.33333333333334,275,-186.66666666666666,275,-160C275,-133.33333333333334,275,-106.66666666666667,275,-80C275,-53.333333333333336,275,-26.666666666666668,275,0C275,26.666666666666668,275,53.333333333333336,275,80C275,106.66666666666667,275,133.33333333333334,275,155C275,176.66666666666666,275,193.33333333333334,275,201.66666666666666L275,210"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text x="275"
                                        y="-89.50967407226562" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">right</text>
                                </g>
                                <g id="Player<:right:Player1->Player4">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-115,-212.41379310344826L-130.83333333333334,-203.67816091954023C-146.66666666666666,-194.94252873563218,-178.33333333333334,-177.47126436781608,-194.16666666666666,-155.4022988505747C-210,-133.33333333333334,-210,-106.66666666666667,-210,-80C-210,-53.333333333333336,-210,-26.666666666666668,-202.84517669677734,-6.178511301676433C-195.6903533935547,14.309644063313803,-181.38070678710938,28.619288126627605,-174.22588348388672,35.77411015828451L-167.07106018066406,42.928932189941406">
                                    </path>
                                    <path
                                        d="M-115,-212.41379310344826L-130.83333333333334,-203.67816091954023C-146.66666666666666,-194.94252873563218,-178.33333333333334,-177.47126436781608,-194.16666666666666,-155.4022988505747C-210,-133.33333333333334,-210,-106.66666666666667,-210,-80C-210,-53.333333333333336,-210,-26.666666666666668,-201.66666666666666,-5C-193.33333333333334,16.666666666666668,-176.66666666666666,33.333333333333336,-168.33333333333334,41.666666666666664L-160,50"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="-209.88050842285156" y="-95.6551742553711" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">right</text>
                                </g>
                                <g id="Player<:right:Player2->Player4">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-386.25,-50L-389.375,-41.666666666666664C-392.5,-33.333333333333336,-398.75,-16.666666666666668,-365.97532653808594,2.1102078755696616C-333.2006530761719,20.88708241780599,-261.40130615234375,41.77416483561198,-225.5016326904297,52.217706044514976L-189.60195922851562,62.66124725341797">
                                    </path>
                                    <path
                                        d="M-386.25,-50L-389.375,-41.666666666666664C-392.5,-33.333333333333336,-398.75,-16.666666666666668,-364.375,2.575757575757578C-330,21.818181818181824,-255,43.63636363636365,-217.5,54.54545454545456L-180,65.45454545454547"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="-304.6416931152344" y="27.43162727355957" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">right</text>
                                </g>
                                <g id="Player<:right:Player3->Player2">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M225,232.72727272727275L141.66666666666666,220.60606060606062C58.333333333333336,208.4848484848485,-108.33333333333333,184.24242424242425,-191.66666666666666,158.78787878787878C-275,133.33333333333334,-275,106.66666666666667,-275,80C-275,53.333333333333336,-275,26.666666666666668,-284.11521911621094,6.041159311930339C-293.2304382324219,-14.58434804280599,-311.46087646484375,-29.16869608561198,-320.5760955810547,-36.460870107014976L-329.6913146972656,-43.75304412841797">
                                    </path>
                                    <path
                                        d="M225,232.72727272727275L141.66666666666666,220.60606060606062C58.333333333333336,208.4848484848485,-108.33333333333333,184.24242424242425,-191.66666666666666,158.78787878787878C-275,133.33333333333334,-275,106.66666666666667,-275,80C-275,53.333333333333336,-275,26.666666666666668,-285.4166666666667,5C-295.8333333333333,-16.666666666666668,-316.6666666666667,-33.333333333333336,-327.0833333333333,-41.666666666666664L-337.5,-50"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="-121.47676849365234" y="176.34732055664062" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">right</text>
                                </g>
                                <g id="Player<:right:Player4->Player1">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-80,68.23529411764706L-31.666666666666668,56.86274509803922C16.666666666666668,45.490196078431374,113.33333333333333,22.745098039215687,161.66666666666666,-1.9607843137254903C210,-26.666666666666668,210,-53.333333333333336,210,-80C210,-106.66666666666667,210,-133.33333333333334,174.10032558441162,-157.1102091471354C138.20065116882324,-180.8870849609375,66.40130233764648,-201.774169921875,30.501627922058105,-212.21771240234375L-5.398046493530273,-222.6612548828125">
                                    </path>
                                    <path
                                        d="M-80,68.23529411764706L-31.666666666666668,56.86274509803922C16.666666666666668,45.490196078431374,113.33333333333333,22.745098039215687,161.66666666666666,-1.9607843137254903C210,-26.666666666666668,210,-53.333333333333336,210,-80C210,-106.66666666666667,210,-133.33333333333334,172.5,-157.5757575757576C135,-181.81818181818184,60,-203.63636363636363,22.5,-214.54545454545453L-15,-225.45454545454544"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="207.52317810058594" y="-50.38594055175781" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">right</text>
                                </g>
                                <g id="Player<:holding:Player1->Dealer0">
                                    <path marker-end="url(#arrow-10-[#333])"
                                        style="stroke: rgb(51, 51, 51); stroke-width: 1; fill: none;"
                                        d="M-15,-215.75757575757575L4.166666666666667,-206.46464646464645C23.333333333333332,-197.17171717171718,61.666666666666664,-178.58585858585857,123.05891418457031,-245.92932252209596C184.45116170247397,-313.2727864583333,268.90232340494794,-466.5455729166667,311.1279042561849,-543.1819661458334L353.3534851074219,-619.818359375">
                                    </path>
                                    <path
                                        d="M-15,-215.75757575757575L4.166666666666667,-206.46464646464645C23.333333333333332,-197.17171717171718,61.666666666666664,-178.58585858585857,123.86321729063617,-247.38906531852092C186.0597679146057,-316.19227205118324,272.1195358292114,-472.38454410236653,315.1494197865142,-550.4806801279582L358.17930374381706,-628.5768161535498"
                                        stroke="transparent" stroke-width="11" fill="none"></path><text
                                        x="207.82745361328125" y="-364.7447204589844" dy="0.33em"
                                        style="font-family: monospace; font-size: 12px; text-anchor: middle; user-select: none;">holding</text>
                                </g>
                            </g>
                        </g>
                    </g>

                </g>
            </svg>
        </div>
    </div>
    <script>
        // Add zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 10]) // Set the zoom scale extent
            .on('zoom', zoomed);

        function zoomed(event) {
            d3.select('.zoomable').attr('transform', event.transform);
        }
        const diagram = d3.select('#diagram');
        diagram.call(zoom);


        // Select all nodes and make them draggable
        const nodes = d3.selectAll('.nodes g');

        function getNodePositions() {
            const positions = {};
            nodes.each(function () {
                const node = d3.select(this);
                const transform = node.attr('transform');
                const translate = transform.match(/translate\(([^, ]+)[, ]+([^)]+)\)/);
                if (translate) {
                    const x = parseFloat(translate[1]);
                    const y = parseFloat(translate[2]);
                    positions[node.attr('id')] = { x, y };
                }
            });
            console.log(positions);
            return positions;
        }

        // Store the initial positions of the nodes
        const nodePositions = getNodePositions();

        function getEdgeSourceAndTarget(edgeId) {
            // First find the id of the last : character and get the substring after it
            const byParts = edgeId.split(':');
            let rel = byParts[byParts.length - 1];

            const [sourceId, targetId] = rel.split('->');
            return { sourceId, targetId };
        }

        function updatePath(path, startX, startY, endX, endY) {
            const controlPoint1 = `${(startX + endX) / 2},${startY}`;
            const controlPoint2 = `${(startX + endX) / 2},${endY}`;
            const newD = `M${startX},${startY} C${controlPoint1},${controlPoint2},${endX},${endY}`;
            path.attr('d', newD);
        }

        function getIntersectionPoint(node, targetNode) {
            const dx = targetNode.x - node.x;
            const dy = targetNode.y - node.y;
            const absDx = Math.abs(dx);
            const absDy = Math.abs(dy);

            let x = node.x;
            let y = node.y;

            const halfWidth = 50;
            const halfHeight = 30;

            if (absDx > absDy) {
                x += dx > 0 ? halfWidth : -halfWidth;
                y += dy * (halfWidth / absDx);
            } else {
                x += dx * (halfHeight / absDy);
                y += dy > 0 ? halfHeight : -halfHeight;
            }

            return { x, y };
        }

        function updateEdges(nodeId) {
            const node = nodePositions[nodeId];
            // Update edges where the node is the source
            d3.selectAll(`g[id*=":${nodeId}->"]`).each(function () {
                const edge = d3.select(this);
                const edgeId = edge.attr('id');

                const { sourceId, targetId } = getEdgeSourceAndTarget(edgeId);
                //assert (sourceId === nodeId);

                const targetNode = nodePositions[targetId];
                const sourceIntersection = getIntersectionPoint(node, targetNode);
                const targetIntersection = getIntersectionPoint(targetNode, node);
                edge.select('path').each(function () {
                    updatePath(d3.select(this), sourceIntersection.x, sourceIntersection.y, targetIntersection.x, targetIntersection.y);
                });

                // Update the position of the label
                edge.select('text').attr('x', (sourceIntersection.x + targetIntersection.x) / 2)
                    .attr('y', (sourceIntersection.y + targetIntersection.y) / 2);
            });

            // Update edges where the node is the target
            d3.selectAll(`g[id*="->${nodeId}"]`).each(function () {
                const edge = d3.select(this);
                const edgeId = edge.attr('id');

                const { sourceId, targetId } = getEdgeSourceAndTarget(edgeId);
                //assert (targetId === nodeId);

                const sourceNode = nodePositions[sourceId];
                const sourceIntersection = getIntersectionPoint(sourceNode, node);
                const targetIntersection = getIntersectionPoint(node, sourceNode);
                edge.select('path').each(function () {
                    updatePath(d3.select(this), sourceIntersection.x, sourceIntersection.y, targetIntersection.x, targetIntersection.y);
                });

                // Update the position of the label
                edge.select('text').attr('x', (sourceIntersection.x + targetIntersection.x) / 2)
                    .attr('y', (sourceIntersection.y + targetIntersection.y) / 2);
            });
        }

        nodes
            .call(d3.drag()
                .on('start', dragStarted)
                .on('drag', dragged)
                .on('end', dragEnded));

        function dragStarted(event, d) {
            d3.select(this).raise().attr('stroke', 'black');
        }

        function dragged(event, d) {
            const nodeId = d3.select(this).attr('id');
            nodePositions[nodeId].x = event.x;
            nodePositions[nodeId].y = event.y;
            d3.select(this).attr('transform', `translate(${event.x}, ${event.y})`);
            updateEdges(nodeId); // Update the edges during the drag event
        }

        function dragEnded(event, d) {
            d3.select(this).attr('stroke', null);
        }



        /**** This bit ensures we zoom to fit ***/
        const bbox = d3.select('.zoomable').node().getBBox();
        const padding = 10; // Padding in pixels

        const viewBox = [
            bbox.x - padding,
            bbox.y - padding,
            bbox.width + 2 * padding,
            bbox.height + 2 * padding
        ].join(' ');


        const topSvg = d3.select("#diagram");
        topSvg.attr('viewBox', viewBox);
        /*************************************/

    </script>
</body>

</html>